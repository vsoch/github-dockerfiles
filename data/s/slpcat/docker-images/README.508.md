Ambassador Unit Tests
=====================

Unit tests for Ambassador live in the `ambassador/tests` directory. Within that directory, you'll find directories with names that start with three digits (`000-default`, `001-broader-v0`, etc); each of these directories describes a test environment. Tests run on every build of Ambassador, and test Ambassador's ability to transform a known Ambassador configuration into a known intermediate configuration and a known Envoy configuration.

**You are strongly encouraged to add tests when you add features.** Adding a new test is simply a matter of adding a new test directory under `ambassador/tests`. Start its name with three digits; the rest of the name should be a brief description of what you're testing, with no spaces.

Call the test directory (e.g. `ambassador/tests/002-tls-module-1`) `$TESTDIR`. Then:

- The test MUST contain an Ambassador configuration.
   - For every test except `000-default`, the configuration is the set of YAML files in `$TESTDIR/config`. 
      - The `000-default` test is special: it contains the magic `TEST_DEFAULT_CONFIG` marker, which says to use `ambassador/default-config` for configuration.
   - Some tests will also need to include other files, e.g. TLS certificates. These should be in `config` as well -- see the `002-tls-module-1` test for an example.

- The test SHOULD contain a known-good Ambassador intermediate configuration dump.
   - The intermediate configuration is generated by `ambassador dump`.
   - The known good intermediate configuration is in `$TESTDIR/gold.intermediate.json`.
   - If `gold.intermediate.json` is present, the test will generate `$TESTDIR/intermediate.json` and compare it with the known good version.

- The test SHOULD contain a known-good Envoy configuration dump.
   - The Envoy configuration is generated by `ambassador config`.
   - The known good Envoy configuration is in `$TESTDIR/gold.json`.
   - If `gold.json` is present:
      - The test will generate `$TESTDIR/envoy.json` and compare it with the known good version.
      - The test will also hand `$TESTDIR/envoy.json` to Envoy for validation -- this step runs inside Docker, and the test directory is mounted inside the Docker container as `/etc/ambassador-config`.

- In all cases, Ambassador's diagnostic service is invoked on the Ambassador configuration, and the results are checked for internal consistency.

To extend a test, change the configuration in `$TESTDIR/config`, then run a build (`make DOCKER_REGISTRY=-`) which will run all the CI tests. The tests will fail - if not, you didn't really change the test configuration, right? - but they'll output the diffs they found against the known-good versions. If all looks well, you can update the known-good versions:

- `mv $TESTDIR/intermediate.json $TESTDIR/gold.intermediate.json`
- `mv $TESTDIR/envoy.json $TESTDIR/gold.json`

and then commit all the changes you made in `$TESTDIR`.

The Diagnostics Consistency Test
--------------------------------

The diagnostics consistency test is complex:

   - The test parses the Ambassador configuration into a `Config` object.
   - The test pulls the diagnostic overview from the `Config` object.
   - The test builds a _reconstituted version_ of the diag data as follows:
      - for each source file listed in the overview
         - grab the targeted diagnostics for that service
         - sanitize merge the targeted version into the reconstituted version
   - The test makes sure that the reconstituted version and the sanitized version of the overview match.

If this test finds differences at the last step, you will see the error message `mismatch between overview and reconstituted diagnostics`. It will include a diff between the two versions, plus the raw JSON of both versions, which will hopefully give you a sense of where to look.

The most likely cause for this error is that you've added some global configuration data that are fairly complex, and the reconstituter doesn't know how to handle it. It's worth noting, though, that the reconstitution and sanitization are ugly, enough so that I've been questioning the value of the check for awhile: as the data structures get more complex, it becomes harder to know that the check is helpful.

For now, though, start with `diag_paranoia.py`; the entry point for the diagnostics check is the `diag_paranoia` function. The obvious places to check:

- Some configuration data will never appear, at present, when asking the diag system for data by source file. `diag_paranoia` may not be properly carrying that data over from the overview (see `diag_paranoia.py` lines 238-243).

- The `Uniqifiers` dict (starts at line 26) tells the system how to go from an Ambassador object to a unique key for that instance. This may need updating.

- `diag_paranoia` may be entirely skipping your information in its loop that tries to take interesting things and work with them (`diag_paranoia.py` line 125 is the start of the loop).
